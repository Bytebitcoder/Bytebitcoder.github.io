---
layout: post
title: 小工具
date: 2018-07-30 
tags: C#    
---
# 做一个监视系统文件变化的小工具
## 界面
监视文件和文件夹的变化（FileSystemWatcher 类）：选择一个文件夹，单击“开始监视”，该文件夹处于监视状态，此时对该文件夹如果进行操作，这些行为将显示出来

![](/images/C#/1.png)

## 简要分析
* 首先浏览文件夹并选择路径
在窗体上设置一个按钮，命名为浏览文件夹，点击这个按钮后，弹出选择文件的对话框，提供可以选择的文件夹路径，以便选中文件夹。
* 手动输入文件夹路径
在窗体上设置一个文本框，可以点击后键入文件夹路径。
* 监视文件夹
在窗体上设置一个按钮，点击后开始监视所选择的文件夹，并在窗体上设置一个文本框，将该文件夹及其子文件夹下发生的变化（新建，删除，修改，更名）在文本框上显示。

## 控件介绍
一共使用到了三个控件：**Label**、**Button**、**Textbox**。
* Label
Label控件最主要的目的就是提示用户Textbox控件中所显示的内容所代表的含义。
* Button
Button控件的目的是为提供用户可以浏览文件夹以及开始监视该文件夹的操作。
* Textbox
Textbox控件的目的主要是显示出所要监视的文件夹的路径，并提供手动输入文件夹路径的方法，并显示被监视文件夹的状态变化。

## 使用到的类的介绍
* FolderBrowserDialog类
FolderBrowserDialog类是提示用户选中一个文件夹，定义一个FolderBrowserDialog对象，调用这个类的方法ShowDialog，弹出一个提示选择文件夹的对话框。选择文件夹之后，这个文件夹的绝对路径将会保存在这个类Selected属性之中。
* FileSystemWatcher类
监控指定文件或目录的文件的创建、删除、改动、重命名等活动。可以动态地定义需要监控的文件类型及文件属性改动的类型。
  * 常用的属性介绍
    * Path ：设置要监视的目录的路径。
    * IncludeSubdirectories ：设置是否级联监视指定路径中的子目录。
    * Filter ：设置筛选字符串，用于确定在目录中监视哪些类型的文件。
    * NotifyFilter ：设置文件的哪些属性的变动会触发Changed事件，同时监控多个属性变动可以按“或”组合。（默认值为NotifyFilter.LastWrite|NotifyFilter.FileName|NotifyFilter.DirectoryName 组合）
    子项： 
          1. Attributes     --  文件或文件夹的属性。
          2. CreationTime   --  文件或文件夹的创建时间。
          3. DirectoryName  --  目录名。（常用）
          4. FileName       --  文件名。（常用）
          5. LastAccess     --  文件或文件夹上一次打开的日期。
          6. LastWrite      --  上一次向文件或文件夹写入内容的日期。
          7. Security       --  文件或文件夹的安全设置。
          8. Size           --  文件或文件夹的大小。（常用）
  * 常用事件
    * Changed  ：当更改文件和目录时发生，可以通过NotifyFilter属性设置触发该事件的需要文件更改的属性。
    * Created  ：当创建文件和目录时发生。
    * Deleted  ：删除文件或目录时发生。
    * Renamed  ：重命名文件或目录时发生。
    * FileSystemEventArgs 对象：
  
        成员： 
      1. Name：获取受影响的文件或目录的名称。 注意：如果是级联监控子目录的话，该值为从监控目录的下个目录到受影响的文件的路径，而不只是受影响的文件名。
      2. FullPath ： 获取受影响的文件或目录的完全限定的路径。 
      3. ChangeType ：获取受影响的文件或目录的发生的事件类型。

        子项： 
      1.  All  -- 文件或文件夹的创建、删除、更改或重命名。
          Changed  -- 文件或文件夹的更改。更改的类型包括大小、属性、安全设置、最近写入时间和最近访问时间方面的更改。
      2. Created  -- 文件或文件夹的创建。
      3. Deleted  --  文件或文件夹的删除。
      4. Renamed  --  文件或文件夹的重命名。

    * RenamedEventArgs 对象：
       成员： 
       1. Name：           获取受影响的文件或目录的新名称。
       2. OldName ：    获取受影响的文件或目录的旧名称。
       3. FullPath ：      获取受影响的文件或目录的完全限定的路径。
       4. OldFullPath ： 获取受影响的文件或目录的前一个完全限定的路径。
       5. ChangeType ：获取受影响的文件或目录的发生的事件类型。

       子项： 
       1. All      -- 文件或文件夹的创建、删除、更改或重命名。
       2. Changed  -- 文件或文件夹的更改。更改的类型包括大小、属性、安全设置、最近写入时间和最近访问时间方面的更改。
       3. Created  -- 文件或文件夹的创建。
       4. Deleted  --  文件或文件夹的删除。
       5. Renamed  --  文件或文件夹的重命名。

## 流程，设计思路

![](/images/C#/2.png)

1. 首先根据需要在设计视图中拖拽第一个Button置于右上角，并在属性中更改其Text属性为“浏览文件夹”，接着拖拽一个Label置于左上角，更改Text属性为“文件夹全路径名”，继续拖拽一个Textbox置于该Label下方，继续拖拽第二个Label置于该Text下方左侧，更改Text属性为“文件系统变化情况”，拖拽第二个Button置于该Text下方右侧，更改Text属性为“开始监视”，拖拽第二个Textbox填满剩余空间。
2. 点击浏览文件夹按钮时，调用FolderBrowserDialog类，弹出选择文件夹对话框，因为选择完成后该路径会保存在FolderBrowserDialog类的对象的属性Selected中，所以可以将该值赋给第一个Textbox显示，以便用户知道监视的文件夹路径，同时因为用户可能希望手动输入路径，所以该Textbox的Text属性也可以经由用户键入更改。
3. 当键入路径或者选择完文件夹路径后，点击开始监视后调用FileSystemWatcher类，因为本次课设我将这个类的一个对象作为了类中的一个成员变量，点击“开始监视”按钮后首先判断文件夹路径是否存在，存在才会监视，不存在调用Messagebox类的show函数来告知未选择正确的文件夹路径。
4. 在类的成员变量中，我还设置了一个string类型的oldpath变量来存放上一次监视的文件夹路径名，处置为空字符串，如果选择的是正确的文件夹，那么将oldpath改为当前监视的文件夹路径，并将更改第二个Textbox的方法加入到FileSystemWatcher的对象的Created，Deleted，Changed，Renamed，事件中，而当下一次点击开始监视的时候，仅需改变FileSystemWatcher对象所要监视的路径，即对象的Path属性即可，不然会出现多次加入方法导致变化情况多次输出的bug。
5. 因为涉及到了跨线程更改UI窗体属性，经过网上查询资料，知道需要使用委托的方法，将所要传递的变量封送至主线程来完成UI界面的更改，而因为Renamed所要知道的是旧的文件名以及新的文件名，而增删改只需要知道文件名，所以传递的参数有两个，所以在课设中我写了两个委托，一个用于传递FileSystemEventArgs对象，一个用于传递RenamedEventArgs对象，并通过判断InvokeRequired属性判断是否跨线程，Invoke来将将方法封送至主线程处理得到结果。

## 遇到的两个困难
1. 跨线程更改主线程UI界面
因为涉及到的类是经过点击后触发的事件，并且是开启一个线程对指定文件夹进行监视，在输出文件夹状态变化的时候发现直接书写更改窗体Text属性函数报错，查阅资料发现，因为跨线程不能直接更改主界面UI控件，需要使用委托的方式将更改的值进行传递后再进行更改，所以将监视所触发的新建、删除、修改操作用一个委托将方法封送至主线程，以供其修改，同理，因为更名操作与前三个操作不太一样，需要有更名前的名称，所以单独书写一个委托与方法封送至主线程。
2. 未处理好线程绑定事件而产生的多次输出
因为需要将处理数据的方法与文件夹下发生变化的操作进行绑定，但是没有考虑到此操作写在button_click函数中，所以当运行程序点击第二次开始监视按钮后，又一次将处理数据的方法与操作绑定了，导致如果更改的文件或者文件夹在相同的目录或其子目录下，那么显示变化的操作将会显示两次，对此，加入判断，将选中的路径作为变量，赋值为空字符串，当监视一次后便赋值为监视的文件夹名，当点击开始监视按钮时，判断如果选中的路径这个变量是空，说明是第一次监视，则将方法与操作绑定，得以解决





